const t=t=>new Promise(e=>setTimeout(e,t));class e{ontext=null;constructor(t=/\r?\n/,e=!1){this.eol=t,this.skip=e}reset(){this._buf=""}write(t){if(!this.ontext)return;if(!this.eol)return void this.ontext(t);this._buf+=t;let e=this._buf.split(this.eol);1!=e.length&&(e[e.length-1].length?this._buf=e.pop():(this._buf="",e.pop()),this.skip&&(e.shift(),this.skip=!1),e.forEach(t=>this.ontext(t)))}_buf=""}class s{constructor(){this.chunks=[],this.length=0}clear(){this.chunks=[],this.length=0}push(t){return!(!t||0===t.length||(this.chunks.push(t),this.length+=t.length,0))}shift(t){if(!this.length||!t)return new Uint8Array(0);t>this.length&&(t=this.length);const e=new Uint8Array(t);let s=0;for(;s<t&&this.chunks.length>0;){const i=this.chunks[0];if(!i||0===i.length){this.chunks.shift();continue}const h=Math.min(i.length,t-s);e.set(i.subarray(0,h),s),s+=h,h===i.length?this.chunks.shift():this.chunks[0]=i.subarray(h),this.length-=h}return e}shiftAll(){return this.shift(this.length)}}class i{static State={Closed:"closed",Opening:"opening",Open:"open",Closing:"closing"};onbin=null;ontext=null;onopen(){}onclose(){}onchange(t){}onselect(t){}onerror(t){}constructor(t={}){this.cfg={eol:/\r?\n/,serviceUUID:"0000ffe0-0000-1000-8000-00805f9b34fb",charxUUID:"0000ffe1-0000-1000-8000-00805f9b34fb",auto_open:!1,max_tx:20,reconnect:1e3,...t},this.splitter=new e(this.cfg.eol),this.splitter.ontext=t=>this.ontext(t)}config(t={}){this.cfg={...this.cfg,...t},this.splitter.eol=this.cfg.eol}static supported(){return"bluetooth"in navigator}opened(){return this._state===i.State.Open}selected(){return!!this._device}getName(){return this._device?this._device.name:null}async select(){try{await this.close(),this._device&&this._device.removeEventListener("gattserverdisconnected",this._disconnect_h),this._device=await navigator.bluetooth.requestDevice({filters:[{services:[this.cfg.serviceUUID]}],optionalServices:[this.cfg.serviceUUID]}),this._device.addEventListener("gattserverdisconnected",this._disconnect_h)}catch(t){this._error(t),this._device=null}return this.onselect(this.getName()),this.cfg.auto_open&&this.open(),this.selected()}async open(){this._device&&(this.opened()||(this.cfg.reconnect&&(this.retry=!0),await this._open()))}async _open(){if(this._state==i.State.Closed){this._change(i.State.Opening);try{const t=await this._device.gatt.connect(),e=await t.getPrimaryService(this.cfg.serviceUUID);this._charx=await e.getCharacteristic(this.cfg.charxUUID),await this._charx.startNotifications(),this._charx.addEventListener("characteristicvaluechanged",this._data_h),this._buffer.clear(),this._change(i.State.Open)}catch(e){this._error(e),this._change(i.State.Closed),this.retry&&t(this.cfg.reconnect).then(()=>this._open())}}}async close(){this.retry=!1,this.opened()&&await this._close()}async _close(){this._change(i.State.Closing);try{this._device.gatt.disconnect()}catch(t){this._error(t)}}async sendText(t){await this.sendBin((new TextEncoder).encode(t))}async sendBin(t){this._buffer.push(t),this._send()}_device=null;_charx=null;_state=i.State.Closed;_buffer=new s;_decoder=new TextDecoder;async _disconnect(e){this._change(i.State.Closed),this._charx&&this._charx.removeEventListener("characteristicvaluechanged",this._data_h),this._charx=null,this.retry&&t(this.cfg.reconnect).then(()=>this._open()),await t(50)}_disconnect_h=this._disconnect.bind(this);_data(t){const e=t.target.value,s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this.onbin&&this.onbin(s),this.ontext&&this.splitter.write(this._decoder.decode(s,{stream:!0}))}_data_h=this._data.bind(this);async _send(){if(!this._busy){for(this._busy=!0;this._buffer.length&&this._charx;){let t=this._buffer.shift(this.cfg.max_tx);try{t.length&&await this._charx.writeValueWithoutResponse(t)}catch(t){}}this._busy=!1}}_error(t){this.onerror("[BLE] "+t)}_change(t){switch(this._state=t,this.onchange(t),t){case i.State.Open:this.onopen();break;case i.State.Closed:this.onclose()}}}export{i as default};